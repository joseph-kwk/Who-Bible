// Bible People Challenge — structured app.js

// =========================
// Default dataset
// =========================
const DEFAULT_PEOPLE_DATA = [
  
  // Replaced with the auto-annotated dataset (generated by tools/auto_annotate.js)

  {
    "name": "Noah",
    "aliases": [],
    "mother": null,
    "occupation": "Righteous man, built the ark",
    "age_notes": "Lived 950 years",
    "notable_events": [
      "Built the ark",
      "Survived the flood",
      "Sent out dove and raven"
    ],
    "verses": [
      "Genesis 6-9",
      "Genesis 9:29"
    ],
    "short_bio": "Noah built the ark to survive the flood.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Moses",
    "aliases": [],
    "mother": "Jochebed",
    "occupation": "Leader, prophet",
    "age_notes": "Died at 120; 80 when confronting Pharaoh",
    "notable_events": [
      "Led Exodus",
      "Saw burning bush",
      "Parted Red Sea",
      "Received Ten Commandments"
    ],
    "verses": [
      "Exodus 3",
      "Exodus 14",
      "Exodus 20",
      "Deuteronomy 34:7"
    ],
    "short_bio": "Moses led the Israelites out of Egypt.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Solomon",
    "aliases": [],
    "mother": "Bathsheba",
    "occupation": "King",
    "age_notes": "Reigned 40 years",
    "notable_events": [
      "Built the temple",
      "Known for wisdom",
      "Judged between two mothers"
    ],
    "verses": [
      "1 Kings 3",
      "1 Kings 6",
      "2 Samuel 12:24"
    ],
    "short_bio": "Son of David and Bathsheba; famed for wisdom.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Joseph (son of Jacob)",
    "aliases": [
      "Joseph of Egypt"
    ],
    "mother": "Rachel",
    "occupation": "Official in Egypt",
    "age_notes": "Sold by brothers at 17; died at 110",
    "notable_events": [
      "Sold into Egypt",
      "Interpreted dreams",
      "Saved Egypt from famine",
      "Reunited with family"
    ],
    "verses": [
      "Genesis 37:2",
      "Genesis 41",
      "Genesis 45",
      "Genesis 50:26"
    ],
    "short_bio": "Joseph was sold into Egypt and rose to power.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "David",
    "aliases": [],
    "mother": null,
    "occupation": "Shepherd, King",
    "age_notes": "Became king at 30; reigned 40 years",
    "notable_events": [
      "Killed Goliath",
      "Became king",
      "Danced before the ark",
      "Committed adultery with Bathsheba"
    ],
    "verses": [
      "1 Samuel 17",
      "2 Samuel 5:4",
      "2 Samuel 6",
      "2 Samuel 11"
    ],
    "short_bio": "Shepherd who became king of Israel; famous for defeating Goliath.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Esther",
    "aliases": [
      "Hadassah"
    ],
    "mother": null,
    "occupation": "Queen",
    "age_notes": null,
    "notable_events": [
      "Became queen and saved her people",
      "Revealed Haman's plot"
    ],
    "verses": [
      "Esther 2",
      "Esther 7"
    ],
    "short_bio": "Jewish queen of Persia who saved her people.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Mary (mother of Jesus)",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Mother of Jesus",
      "Visited by angel Gabriel",
      "Present at crucifixion"
    ],
    "verses": [
      "Luke 1:26-38",
      "John 19:25"
    ],
    "short_bio": "Mother of Jesus.",
    "testament": "nt",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "John the Baptist",
    "aliases": [],
    "mother": "Elizabeth",
    "occupation": "Prophet",
    "age_notes": null,
    "notable_events": [
      "Baptized Jesus",
      "Beheaded by Herod",
      "Wore camel hair"
    ],
    "verses": [
      "Luke 1",
      "Matthew 3",
      "Matthew 14"
    ],
    "short_bio": "Prophet who baptized Jesus.",
    "testament": "nt",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Paul",
    "aliases": [
      "Saul"
    ],
    "mother": null,
    "occupation": "Apostle, tent maker",
    "age_notes": null,
    "notable_events": [
      "Converted on road to Damascus",
      "Missionary journeys",
      "Wrote epistles",
      "Shipwrecked"
    ],
    "verses": [
      "Acts 9",
      "Acts 13-28",
      "2 Corinthians 11:25"
    ],
    "short_bio": "Originally named Saul; became Apostle Paul after conversion.",
    "testament": "nt",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Peter",
    "aliases": [
      "Simon Peter",
      "Simon"
    ],
    "mother": null,
    "occupation": "Fisherman, Apostle",
    "age_notes": null,
    "notable_events": [
      "Walked on water",
      "Denial of Jesus",
      "Leader of early church",
      "Vision of unclean animals"
    ],
    "verses": [
      "Matthew 14:29",
      "Matthew 26:69-75",
      "Acts 10"
    ],
    "short_bio": "One of Jesus's closest disciples; called Peter.",
    "testament": "nt",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Lazarus",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Raised from the dead by Jesus",
      "Brother of Mary and Martha"
    ],
    "verses": [
      "John 11",
      "John 12"
    ],
    "short_bio": "Brother of Mary and Martha; raised from the dead.",
    "testament": "nt",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Abraham",
    "aliases": [
      "Abram"
    ],
    "mother": null,
    "occupation": "Patriarch",
    "age_notes": "Died at 175; fathered Isaac at 100",
    "notable_events": [
      "Father of Isaac",
      "Covenant with God",
      "Nearly sacrificed Isaac",
      "Left Ur"
    ],
    "verses": [
      "Genesis 12",
      "Genesis 17",
      "Genesis 22",
      "Genesis 25:7"
    ],
    "short_bio": "Father of the Israelite nation.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Isaac",
    "aliases": [],
    "mother": "Sarah",
    "occupation": "Patriarch",
    "age_notes": "Died at 180; born when Abraham was 100",
    "notable_events": [
      "Son of Abraham and Sarah",
      "Nearly sacrificed by Abraham",
      "Married Rebekah"
    ],
    "verses": [
      "Genesis 22",
      "Genesis 24",
      "Genesis 35:28"
    ],
    "short_bio": "Son of Abraham and Sarah; father of Jacob.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Jacob",
    "aliases": [
      "Israel"
    ],
    "mother": "Rebekah",
    "occupation": "Patriarch",
    "age_notes": "Died at 147",
    "notable_events": [
      "Renamed Israel",
      "Father of the 12 tribes",
      "Wrestled with angel",
      "Deceived Isaac"
    ],
    "verses": [
      "Genesis 27",
      "Genesis 32:28",
      "Genesis 47:28"
    ],
    "short_bio": "Father of the 12 tribes of Israel.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Samuel",
    "aliases": [],
    "mother": "Hannah",
    "occupation": "Prophet, Judge",
    "age_notes": "Dedicated to temple as child",
    "notable_events": [
      "Anointed Saul and David",
      "Heard God's voice as child",
      "Judge of Israel"
    ],
    "verses": [
      "1 Samuel 3",
      "1 Samuel 10",
      "1 Samuel 16"
    ],
    "short_bio": "Prophet and judge who anointed Israel's first kings.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Elijah",
    "aliases": [],
    "mother": null,
    "occupation": "Prophet",
    "age_notes": null,
    "notable_events": [
      "Taken up by chariot of fire",
      "Defeated prophets of Baal",
      "Fed by ravens",
      "Raised widow's son"
    ],
    "verses": [
      "1 Kings 17",
      "1 Kings 18",
      "2 Kings 2"
    ],
    "short_bio": "Great prophet who was taken to heaven in a chariot.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Jonah",
    "aliases": [],
    "mother": null,
    "occupation": "Prophet",
    "age_notes": null,
    "notable_events": [
      "Swallowed by fish",
      "Preached to Nineveh",
      "Fled from God"
    ],
    "verses": [
      "Jonah 1-4"
    ],
    "short_bio": "Prophet who fled God and was swallowed by a great fish.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Ruth",
    "aliases": [],
    "mother": null,
    "occupation": "Gleaner",
    "age_notes": null,
    "notable_events": [
      "Ancestor of David",
      "Married Boaz",
      "Loyal to Naomi"
    ],
    "verses": [
      "Ruth 1-4"
    ],
    "short_bio": "Moabite woman who became ancestor to King David.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Mary Magdalene",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Witnessed resurrection",
      "Seven demons cast out",
      "Followed Jesus"
    ],
    "verses": [
      "Luke 8:2",
      "Matthew 28",
      "John 20"
    ],
    "short_bio": "Witness of Jesus's resurrection.",
    "testament": "nt",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Saul (first king)",
    "aliases": [],
    "mother": null,
    "occupation": "King",
    "age_notes": "Reigned 40 years",
    "notable_events": [
      "First king of Israel",
      "Consulted witch of Endor",
      "Fell on sword"
    ],
    "verses": [
      "1 Samuel 9-10",
      "1 Samuel 28",
      "1 Samuel 31"
    ],
    "short_bio": "Israel's first king anointed by Samuel.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Daniel",
    "aliases": [],
    "mother": null,
    "occupation": "Prophet, official",
    "age_notes": "Taken to Babylon as youth",
    "notable_events": [
      "In the lion's den",
      "Interpreted dreams",
      "Three friends in furnace"
    ],
    "verses": [
      "Daniel 1",
      "Daniel 3",
      "Daniel 6"
    ],
    "short_bio": "Prophet in Babylon; survived lion's den.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Joshua",
    "aliases": [],
    "mother": null,
    "occupation": "Military leader",
    "age_notes": "Died at 110",
    "notable_events": [
      "Led conquest of Canaan",
      "Walls of Jericho fell",
      "Stopped sun and moon"
    ],
    "verses": [
      "Joshua 1",
      "Joshua 6",
      "Joshua 10:12-13",
      "Joshua 24:29"
    ],
    "short_bio": "Successor to Moses who led Israel into Promised Land.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Deborah",
    "aliases": [],
    "mother": null,
    "occupation": "Prophet, Judge",
    "age_notes": null,
    "notable_events": [
      "Judge of Israel",
      "Led victory over Canaanites",
      "Sang victory song"
    ],
    "verses": [
      "Judges 4-5"
    ],
    "short_bio": "Prophet and judge who led Israel to victory.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Gideon",
    "aliases": [],
    "mother": null,
    "occupation": "Judge",
    "age_notes": null,
    "notable_events": [
      "Defeated Midianites with 300 men",
      "Asked for fleece sign",
      "Tore down Baal altar"
    ],
    "verses": [
      "Judges 6-7"
    ],
    "short_bio": "Judge who defeated the Midianites with 300 men.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Samson",
    "aliases": [],
    "mother": null,
    "occupation": "Judge",
    "age_notes": "Nazirite from birth",
    "notable_events": [
      "Super strength from long hair",
      "Betrayed by Delilah",
      "Killed Philistines"
    ],
    "verses": [
      "Judges 13-16"
    ],
    "short_bio": "Judge with supernatural strength; betrayed by Delilah.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Jeremiah",
    "aliases": [],
    "mother": null,
    "occupation": "Prophet",
    "age_notes": "Called as youth",
    "notable_events": [
      "Wept for Jerusalem",
      "Put in cistern",
      "Prophesied exile"
    ],
    "verses": [
      "Jeremiah 1",
      "Jeremiah 38",
      "Jeremiah 52"
    ],
    "short_bio": "Weeping prophet who warned of Babylon's destruction.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Ezekiel",
    "aliases": [],
    "mother": null,
    "occupation": "Prophet, priest",
    "age_notes": "Exiled to Babylon",
    "notable_events": [
      "Vision of dry bones",
      "Vision of wheels",
      "Temple vision"
    ],
    "verses": [
      "Ezekiel 1",
      "Ezekiel 37",
      "Ezekiel 40-48"
    ],
    "short_bio": "Prophet of the exile with dramatic visions.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Isaiah",
    "aliases": [],
    "mother": null,
    "occupation": "Prophet",
    "age_notes": null,
    "notable_events": [
      "Vision of God's throne",
      "Prophesied Messiah",
      "Walked naked three years"
    ],
    "verses": [
      "Isaiah 6",
      "Isaiah 53",
      "Isaiah 20"
    ],
    "short_bio": "Major prophet who prophesied about the Messiah.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Job",
    "aliases": [],
    "mother": null,
    "occupation": "Wealthy landowner",
    "age_notes": "Lived 140 years after trials",
    "notable_events": [
      "Tested by Satan",
      "Lost everything",
      "Remained faithful",
      "Restored double"
    ],
    "verses": [
      "Job 1-2",
      "Job 42"
    ],
    "short_bio": "Righteous man who suffered but remained faithful.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Nehemiah",
    "aliases": [],
    "mother": null,
    "occupation": "Cupbearer, governor",
    "age_notes": null,
    "notable_events": [
      "Rebuilt Jerusalem walls",
      "Cupbearer to king",
      "Led reforms"
    ],
    "verses": [
      "Nehemiah 1-2",
      "Nehemiah 6"
    ],
    "short_bio": "Led rebuilding of Jerusalem's walls.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Ezra",
    "aliases": [],
    "mother": null,
    "occupation": "Priest, scribe",
    "age_notes": null,
    "notable_events": [
      "Led return from exile",
      "Read law to people",
      "Reformed worship"
    ],
    "verses": [
      "Ezra 7",
      "Nehemiah 8"
    ],
    "short_bio": "Priest and scribe who restored the Law.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Adam",
    "aliases": [],
    "mother": null,
    "occupation": "First man",
    "age_notes": "Lived 930 years",
    "notable_events": [
      "First human created",
      "Ate forbidden fruit",
      "Named the animals"
    ],
    "verses": [
      "Genesis 1-3",
      "Genesis 5:5"
    ],
    "short_bio": "First human created by God.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Eve",
    "aliases": [],
    "mother": null,
    "occupation": "First woman",
    "age_notes": null,
    "notable_events": [
      "First woman created",
      "Ate forbidden fruit",
      "Mother of all living"
    ],
    "verses": [
      "Genesis 2-3"
    ],
    "short_bio": "First woman; mother of all humanity.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Cain",
    "aliases": [],
    "mother": "Eve",
    "occupation": "Farmer",
    "age_notes": null,
    "notable_events": [
      "Killed Abel",
      "First murderer",
      "Mark of Cain"
    ],
    "verses": [
      "Genesis 4"
    ],
    "short_bio": "First son of Adam and Eve; killed his brother.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Abel",
    "aliases": [],
    "mother": "Eve",
    "occupation": "Shepherd",
    "age_notes": null,
    "notable_events": [
      "Killed by Cain",
      "Offered acceptable sacrifice"
    ],
    "verses": [
      "Genesis 4",
      "Hebrews 11:4"
    ],
    "short_bio": "Second son of Adam and Eve; murdered by Cain.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Lot",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Escaped Sodom",
      "Wife turned to salt",
      "Saved by Abraham"
    ],
    "verses": [
      "Genesis 13",
      "Genesis 19"
    ],
    "short_bio": "Abraham's nephew who escaped Sodom's destruction.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Sarah",
    "aliases": [
      "Sarai"
    ],
    "mother": null,
    "occupation": null,
    "age_notes": "Died at 127; gave birth at 90",
    "notable_events": [
      "Wife of Abraham",
      "Mother of Isaac",
      "Laughed at promise"
    ],
    "verses": [
      "Genesis 17",
      "Genesis 18",
      "Genesis 23:1"
    ],
    "short_bio": "Wife of Abraham and mother of Isaac.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Rebekah",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Wife of Isaac",
      "Mother of Jacob and Esau",
      "Helped Jacob deceive Isaac"
    ],
    "verses": [
      "Genesis 24",
      "Genesis 27"
    ],
    "short_bio": "Wife of Isaac; mother of Jacob and Esau.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Rachel",
    "aliases": [],
    "mother": null,
    "occupation": "Shepherdess",
    "age_notes": "Died giving birth to Benjamin",
    "notable_events": [
      "Jacob worked 14 years for her",
      "Mother of Joseph and Benjamin"
    ],
    "verses": [
      "Genesis 29",
      "Genesis 35:16-19"
    ],
    "short_bio": "Beloved wife of Jacob; mother of Joseph.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Leah",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "First wife of Jacob",
      "Mother of six sons",
      "Weak eyes"
    ],
    "verses": [
      "Genesis 29-30"
    ],
    "short_bio": "First wife of Jacob; mother of six of his sons.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Miriam",
    "aliases": [],
    "mother": "Jochebed",
    "occupation": "Prophet",
    "age_notes": null,
    "notable_events": [
      "Watched baby Moses",
      "Led women in song",
      "Struck with leprosy"
    ],
    "verses": [
      "Exodus 2",
      "Exodus 15",
      "Numbers 12"
    ],
    "short_bio": "Sister of Moses and Aaron; prophetess.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Aaron",
    "aliases": [],
    "mother": "Jochebed",
    "occupation": "High priest",
    "age_notes": "Died at 123",
    "notable_events": [
      "First high priest",
      "Made golden calf",
      "Rod that budded"
    ],
    "verses": [
      "Exodus 28",
      "Exodus 32",
      "Numbers 17",
      "Numbers 33:39"
    ],
    "short_bio": "Brother of Moses; first high priest of Israel.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Caleb",
    "aliases": [],
    "mother": null,
    "occupation": "Spy, warrior",
    "age_notes": "Still strong at 85",
    "notable_events": [
      "One of faithful spies",
      "Conquered Hebron"
    ],
    "verses": [
      "Numbers 13-14",
      "Joshua 14"
    ],
    "short_bio": "Faithful spy who trusted God's promise.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Elisha",
    "aliases": [],
    "mother": null,
    "occupation": "Prophet",
    "age_notes": null,
    "notable_events": [
      "Succeeded Elijah",
      "Parted Jordan",
      "Multiplied oil",
      "Raised dead boy"
    ],
    "verses": [
      "1 Kings 19",
      "2 Kings 2",
      "2 Kings 4"
    ],
    "short_bio": "Prophet who succeeded Elijah; performed many miracles.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Naomi",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Mother-in-law of Ruth",
      "Lost husband and sons",
      "Returned to Bethlehem"
    ],
    "verses": [
      "Ruth 1-4"
    ],
    "short_bio": "Mother-in-law of Ruth; returned from Moab.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Boaz",
    "aliases": [],
    "mother": null,
    "occupation": "Wealthy landowner",
    "age_notes": null,
    "notable_events": [
      "Married Ruth",
      "Kinsman redeemer",
      "Ancestor of David"
    ],
    "verses": [
      "Ruth 2-4"
    ],
    "short_bio": "Wealthy man who married Ruth.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Hannah",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Prayed for son",
      "Mother of Samuel",
      "Sang praise song"
    ],
    "verses": [
      "1 Samuel 1-2"
    ],
    "short_bio": "Mother of Samuel; prayed faithfully for a son.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Eli",
    "aliases": [],
    "mother": null,
    "occupation": "High priest, judge",
    "age_notes": "Died at 98",
    "notable_events": [
      "Mentored Samuel",
      "Sons were wicked",
      "Died hearing of ark capture"
    ],
    "verses": [
      "1 Samuel 1-4"
    ],
    "short_bio": "High priest who mentored young Samuel.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Goliath",
    "aliases": [],
    "mother": null,
    "occupation": "Philistine warrior",
    "age_notes": "Over 9 feet tall",
    "notable_events": [
      "Defeated by David",
      "Champion of Philistines"
    ],
    "verses": [
      "1 Samuel 17"
    ],
    "short_bio": "Giant Philistine warrior defeated by David.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Jonathan",
    "aliases": [],
    "mother": null,
    "occupation": "Prince, warrior",
    "age_notes": null,
    "notable_events": [
      "Best friend of David",
      "Gave David his armor",
      "Died with Saul"
    ],
    "verses": [
      "1 Samuel 18",
      "1 Samuel 20",
      "1 Samuel 31"
    ],
    "short_bio": "Son of Saul and loyal friend of David.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Bathsheba",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Committed adultery with David",
      "Mother of Solomon",
      "Husband Uriah killed"
    ],
    "verses": [
      "2 Samuel 11-12",
      "1 Kings 1"
    ],
    "short_bio": "Wife of Uriah then David; mother of Solomon.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "female",
    "_inferred_gender": true
  },
  {
    "name": "Absalom",
    "aliases": [],
    "mother": null,
    "occupation": "Prince",
    "age_notes": null,
    "notable_events": [
      "Rebelled against David",
      "Known for beautiful hair",
      "Hair caught in tree"
    ],
    "verses": [
      "2 Samuel 13-18"
    ],
    "short_bio": "Son of David who rebelled against him.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Elkanah",
    "aliases": [],
    "mother": null,
    "occupation": null,
    "age_notes": null,
    "notable_events": [
      "Father of Samuel",
      "Husband of Hannah"
    ],
    "verses": [
      "1 Samuel 1"
    ],
    "short_bio": "Father of Samuel; husband of Hannah and Peninnah.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  },
  {
    "name": "Mordecai",
    "aliases": [],
    "mother": null,
    "occupation": "Official",
    "age_notes": null,
    "notable_events": [
      "Cousin of Esther",
      "Exposed assassination plot",
      "Honored by king"
    ],
    "verses": [
      "Esther 2-10"
    ],
    "short_bio": "Cousin of Esther who helped save the Jews.",
    "testament": "ot",
    "_inferred_testament": true,
    "gender": "male",
    "_inferred_gender": true
  }
];

// =========================
// State
// =========================
const state = {
  mode: 'idle', // 'solo' | 'timed' | 'challenge' | 'study'
  score: 0,
  streak: 0,
  qnum: 0,
  qtotal: 0,
  questions: [],
  current: null,
  players: [ { name: 'P1', score: 0 }, { name: 'P2', score: 0 } ],
  currentPlayerIndex: 0,
  timerSecondsRemaining: 0,
  timerId: null,
  people: [],
  candidates: [],
  acceptedCandidates: [],
  results: [],
  paused: false,
  theme: 'night',
  currentPlayer: null  // Stores logged-in player info
};


// Normalize and validate people data at startup to avoid incorrect fields
function normalizePeopleData(peopleArray) {
  const norm = peopleArray.map(p => {
    // ensure name exists
    if (!p.name) return null;

    // normalize mother/father/spouse: convert null to empty string
    if (p.mother === null) p.mother = '';
    if (p.father === null) p.father = '';
    if (p.spouse === null) p.spouse = '';

    // standardize gender values
    if (p.gender) {
      const g = String(p.gender).toLowerCase();
      if (g.startsWith('f')) p.gender = 'female';
      else if (g.startsWith('m')) p.gender = 'male';
      else p.gender = 'unknown';
    } else {
      p.gender = 'unknown';
    }

    // specific known-data fix: Deborah was incorrectly labeled male in source
    if (p.name && p.name.toLowerCase().includes('deborah')) {
      p.gender = 'female';
    }

    return p;
  }).filter(Boolean);
  return norm;
}

// Initialize in-memory people from the canonical DEFAULT_PEOPLE_DATA
// Use a shallow copy to avoid mutating the original constant directly
state.people = normalizePeopleData(Array.isArray(DEFAULT_PEOPLE_DATA) ? DEFAULT_PEOPLE_DATA.slice() : []);

// =========================
// Player Authentication & Stats
// =========================
function loadPlayer() {
  try {
    const playerData = localStorage.getItem('who-bible-player');
    if (playerData) {
      state.currentPlayer = JSON.parse(playerData);
      return state.currentPlayer;
    }
  } catch(_) {}
  return null;
}

function savePlayer(player) {
  try {
    localStorage.setItem('who-bible-player', JSON.stringify(player));
    state.currentPlayer = player;
  } catch(_) {}
}

function createGuestPlayer(name = 'Guest') {
  return {
    id: 'guest_' + Date.now(),
    name: name || 'Guest',
    isGuest: true,
    stats: initializeStats(),
    createdAt: new Date().toISOString()
  };
}

function createRegisteredPlayer(name, email) {
  return {
    id: 'player_' + Date.now(),
    name: name,
    email: email || '',
    isGuest: false,
    stats: initializeStats(),
    createdAt: new Date().toISOString()
  };
}

function initializeStats() {
  return {
    gamesPlayed: 0,
    totalScore: 0,
    highestScore: 0,
    bestStreak: 0,
    totalCorrect: 0,
    totalQuestions: 0,
    averageScore: 0,
    winRate: 0,
    soloGames: 0,
    timedGames: 0,
    challengeGames: 0,
    lastPlayedAt: null,
    favoriteMode: 'solo'
  };
}

function updatePlayerStats(score, streak, correct, total, mode) {
  if (!state.currentPlayer) return;
  
  const stats = state.currentPlayer.stats;
  stats.gamesPlayed++;
  stats.totalScore += score;
  stats.highestScore = Math.max(stats.highestScore, score);
  stats.bestStreak = Math.max(stats.bestStreak, streak);
  stats.totalCorrect += correct;
  stats.totalQuestions += total;
  stats.averageScore = Math.round(stats.totalScore / stats.gamesPlayed);
  stats.winRate = Math.round((stats.totalCorrect / stats.totalQuestions) * 100);
  stats.lastPlayedAt = new Date().toISOString();
  
  // Track mode preferences
  if (mode === 'solo') stats.soloGames++;
  else if (mode === 'timed') stats.timedGames++;
  else if (mode === 'challenge') stats.challengeGames++;
  
  // Determine favorite mode
  const modes = {
    solo: stats.soloGames,
    timed: stats.timedGames,
    challenge: stats.challengeGames
  };
  stats.favoriteMode = Object.keys(modes).reduce((a, b) => modes[a] > modes[b] ? a : b);
  
  savePlayer(state.currentPlayer);
}

function promptForPlayerName() {
  const name = prompt(getText('enterPlayerName') || 'Enter your name (or leave blank for Guest):');
  if (name === null) return null; // User cancelled
  
  if (name && name.trim()) {
    const player = createGuestPlayer(name.trim());
    savePlayer(player);
    showToast({ title: getText('welcome') || 'Welcome', msg: `${getText('welcomePlayer') || 'Welcome'}, ${player.name}!`, type: 'success', timeout: 2000 });
    return player;
  } else {
    const player = createGuestPlayer('Guest');
    savePlayer(player);
    return player;
  }
}

function getPlayerStats() {
  if (!state.currentPlayer) return null;
  return state.currentPlayer.stats;
}

function displayPlayerInfo() {
  if (!state.currentPlayer) return;
  
  const welcomeEl = document.getElementById('welcome-message');
  if (welcomeEl) {
    const stats = state.currentPlayer.stats;
    welcomeEl.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <h3>Welcome, ${state.currentPlayer.name}!</h3>
        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 16px; flex-wrap: wrap;">
          <div><strong>Games:</strong> ${stats.gamesPlayed}</div>
          <div><strong>High Score:</strong> ${stats.highestScore}</div>
          <div><strong>Best Streak:</strong> ${stats.bestStreak}</div>
          <div><strong>Win Rate:</strong> ${stats.winRate}%</div>
        </div>
      </div>
    `;
  }
  updatePlayerDisplayName();
}

function updatePlayerDisplayName() {
  const playerNameEl = document.getElementById('current-player-name');
  if (playerNameEl && state.currentPlayer) {
    playerNameEl.textContent = state.currentPlayer.name;
  }
}

// =========================
// Elements
// =========================
// Panels
const setupPanel = document.getElementById('setup-panel');
const gameArea = document.getElementById('game-area');
const studyPanel = document.getElementById('study-panel');

// Setup elements
const btnSolo = document.getElementById('btn-solo');
const btnTimed = document.getElementById('btn-timed');
const btnChallenge = document.getElementById('btn-challenge');
const btnStudy = document.getElementById('btn-study');
const difficultySel = document.getElementById('difficulty');
const numQuestionsInput = document.getElementById('num-questions');
const timeLimitInput = document.getElementById('time-limit');
const btnExport = document.getElementById('btn-export');
const btnImport = document.getElementById('btn-import');
const btnResetData = document.getElementById('btn-reset-data');
const fileInput = document.getElementById('file-input');

// Game elements
const btnBackToSetup = document.getElementById('btn-back-to-setup');
const gameTitle = document.getElementById('game-title');
const quizEl = document.getElementById('quiz');
const qText = document.getElementById('question-text');
const answersEl = document.getElementById('answers');
const scoreEl = document.getElementById('score');
const streakEl = document.getElementById('streak');
const qnumEl = document.getElementById('qnum');
const qtotalEl = document.getElementById('qtotal');
const afterRef = document.getElementById('after-ref');
const btnNext = document.getElementById('btn-next');
const btnQuit = document.getElementById('btn-quit');
const btnPause = document.getElementById('btn-pause');
const timerEl = document.getElementById('timer');
const timeRemainingEl = document.getElementById('time-remaining');
const challengeStatusEl = document.getElementById('challenge-status');
const currentPlayerEl = document.getElementById('current-player');
const p1ScoreEl = document.getElementById('p1-score');
const p2ScoreEl = document.getElementById('p2-score');
const progressBarEl = document.getElementById('progress-bar');

// Study elements
const btnBackFromStudy = document.getElementById('btn-back-from-study');
const searchPerson = document.getElementById('search-person');
const sortSelect = document.getElementById('sort-select');
const filterMother = document.getElementById('filter-mother');
const filterOccupation = document.getElementById('filter-occupation');
const filterAge = document.getElementById('filter-age');
const showDetailsToggle = document.getElementById('show-details-toggle');
const motherSelect = document.getElementById('mother-select');
const showRelativesToggle = document.getElementById('show-relatives-toggle');
const showMothersOnly = document.getElementById('show-mothers-only');
const testamentSelect = document.getElementById('testament-select');
const genderSelect = document.getElementById('gender-select');
const peopleCountEl = document.getElementById('people-count');

// Language selector
const languageSelect = document.getElementById('language-select');
const btnShuffleList = document.getElementById('btn-shuffle-list');
const btnExpandAll = document.getElementById('btn-expand-all');
const btnCollapseAll = document.getElementById('btn-collapse-all');
const peopleList = document.getElementById('people-list');

// Modal elements
const modalEl = document.getElementById('summary-modal');
const summaryStatsEl = document.getElementById('summary-stats');
const summaryListEl = document.getElementById('summary-list');
const btnSummaryClose = document.getElementById('btn-summary-close');
const btnPlayAgain = document.getElementById('btn-play-again');
const playersModal = document.getElementById('players-modal');
const btnPlayersClose = document.getElementById('btn-players-close');
const btnPlayersCancel = document.getElementById('btn-players-cancel');
const btnPlayersStart = document.getElementById('btn-players-start');
const p1NameInput = document.getElementById('p1-name');
const p2NameInput = document.getElementById('p2-name');

// Theme and toasts
const btnTheme = document.getElementById('btn-theme');
const toastContainer = document.getElementById('toast-container');
// Nav
const btnShare = document.getElementById('btn-share');
const navCommunity = document.getElementById('nav-community');
const footerCommunity = document.getElementById('footer-community');

// Community elements
// Community elements removed on main page (moved to community.html)

// =========================
// Translation functions (using centralized JSON translations)
// =========================
function translateEvent(event) {
  if (!event) return event;
  const lang = (typeof currentLanguage !== 'undefined' ? currentLanguage : (window.currentLanguage || 'en'));
  if (lang === 'en') return event;
  try{
    const mapping = (window.TRANSLATIONS && window.TRANSLATIONS[lang] && window.TRANSLATIONS[lang].eventTranslations) || null;
    if(mapping && mapping[event]) return mapping[event];
  }catch(_){ }
  return event; // fallback to original text
}

function translateOccupation(text){
  if(!text) return text;
  const lang = (typeof currentLanguage !== 'undefined' ? currentLanguage : (window.currentLanguage || 'en'));
  if (lang === 'en') return text;
  try{
    const mapping = (window.TRANSLATIONS && window.TRANSLATIONS[lang] && window.TRANSLATIONS[lang].occupationTranslations) || null;
    if(mapping && mapping[text]) return mapping[text];
  }catch(_){ }
  return text; // fallback to original text
}

function translateAnswerForQuestionType(qType, value){
  if(qType==='occupation') return translateOccupation(value);
  if(qType==='age') return translateEvent(value);
  return value; // names and mothers remain as-is
}

// =========================
// Init
// =========================
init();

function init(){
  // Set default settings if not present
  const defaultSettings = {
    difficulty: 'medium',
    numQuestions: 10,
    timeLimit: 60,
    theme: 'night',
    language: 'en'
  };
  let savedSettings = loadSettings();
  if(!savedSettings){
    savedSettings = { ...defaultSettings };
    localStorage.setItem('settings', JSON.stringify(savedSettings));
  }
  // Apply settings to UI and state
  difficultySel.value = savedSettings.difficulty ?? defaultSettings.difficulty;
  numQuestionsInput.value = String(savedSettings.numQuestions ?? defaultSettings.numQuestions);
  timeLimitInput.value = String(savedSettings.timeLimit ?? defaultSettings.timeLimit);
  // Apply testament/gender to UI if present
  if(testamentSelect) testamentSelect.value = savedSettings.testament || defaultSettings.testament;
  if(genderSelect) genderSelect.value = savedSettings.gender || 'all';
  
  // Ensure theme is applied - force initial application
  const themeToApply = savedSettings.theme || defaultSettings.theme;
  console.log('Initial theme to apply:', themeToApply); // Debug
  applyTheme(themeToApply);
  // Set language
  const savedLang = localStorage.getItem('who-bible-language');
  if (savedLang && TRANSLATIONS[savedLang] !== undefined) {
    setLanguage(savedLang);
  } else if(savedSettings.language && TRANSLATIONS[savedSettings.language] !== undefined) {
    setLanguage(savedSettings.language);
  } else {
    setLanguage(defaultSettings.language);
  }
  state.people = loadPeopleDataFromLocalStorage() || DEFAULT_PEOPLE_DATA.slice();
  
  // Load or create player
  // Render dataset stats audit in Study panel
  try{ renderDatasetStats(); }catch(_){ /* ignore if function not yet defined during early load */ }
  const player = loadPlayer();
  if (player) {
    state.currentPlayer = player;
    displayPlayerInfo();
  } else {
    // Prompt for player name on first visit
    setTimeout(() => {
      const newPlayer = promptForPlayerName();
      if (newPlayer) {
        displayPlayerInfo();
      }
    }, 1000);
  }
  
  renderPeopleList();
  attachHandlers();
  // Footer year
  const fy = document.getElementById('footer-year');
  if (fy) fy.textContent = String(new Date().getFullYear());
  // Welcome toast
  showToast({ title: getText('brandTitle'), msg: getText('welcomeMessage'), type: 'info', timeout: 4000 });
}

function attachHandlers(){
  // Home link handler
  const homeLink = document.getElementById('home-link');
  if (homeLink) {
    homeLink.addEventListener('click', (e)=>{ e.preventDefault(); showSetup(); });
  }
  
  // Player management
  const btnChangePlayer = document.getElementById('btn-change-player');
  if (btnChangePlayer) {
    btnChangePlayer.addEventListener('click', ()=>{
      const newPlayer = promptForPlayerName();
      if (newPlayer) {
        displayPlayerInfo();
        updatePlayerDisplayName();
      }
    });
  }
  
  // Mode buttons
  btnSolo.addEventListener('click', startSolo);
  btnTimed.addEventListener('click', startTimed);
  btnChallenge.addEventListener('click', startChallenge);
  btnStudy.addEventListener('click', startStudy);
  
  // Navigation
  btnBackToSetup.addEventListener('click', showSetup);
  btnBackFromStudy.addEventListener('click', showSetup);
  // Community moved to separate page
  
  // Game controls
  btnNext.addEventListener('click', nextQuestion);
  btnQuit.addEventListener('click', quitQuiz);
  btnPause.addEventListener('click', togglePause);
  
  // Study controls
  searchPerson.addEventListener('input', e=>renderPeopleList(e.target.value));
  sortSelect.addEventListener('change', ()=>renderPeopleList(searchPerson.value));
  filterMother.addEventListener('change', ()=>renderPeopleList(searchPerson.value));
  filterOccupation.addEventListener('change', ()=>renderPeopleList(searchPerson.value));
  filterAge.addEventListener('change', ()=>renderPeopleList(searchPerson.value));
  btnShuffleList.addEventListener('click', ()=>{ shuffle(state.people); renderPeopleList(searchPerson.value); });
  btnExpandAll.addEventListener('click', ()=>toggleAllDetails(true));
  btnCollapseAll.addEventListener('click', ()=>toggleAllDetails(false));
  if(showDetailsToggle){ showDetailsToggle.addEventListener('change', ()=>renderPeopleList(searchPerson.value)); }
  if(showRelativesToggle){ showRelativesToggle.addEventListener('change', ()=>renderPeopleList(searchPerson.value)); }
  if(motherSelect){ motherSelect.addEventListener('change', ()=>renderPeopleList(searchPerson.value)); }
  if(showMothersOnly){ showMothersOnly.addEventListener('change', ()=>renderPeopleList(searchPerson.value)); }
  if(testamentSelect){ testamentSelect.addEventListener('change', ()=>{ saveSettingsFromUI(); renderPeopleList(searchPerson.value); }); }
  if(genderSelect){ genderSelect.addEventListener('change', ()=>{ saveSettingsFromUI(); renderPeopleList(searchPerson.value); }); }
  
  // Data management
  btnExport.addEventListener('click', exportJson);
  btnImport.addEventListener('click', ()=>fileInput.click());
  btnResetData.addEventListener('click', resetData);
  fileInput.addEventListener('change', handleImportFile);

  // Data Quality / Person Editor wiring
  const btnDQ = document.getElementById('btn-data-quality');
  if (btnDQ) btnDQ.addEventListener('click', showDataQualityModal);
  const dqClose = document.getElementById('btn-data-quality-close');
  if (dqClose) dqClose.addEventListener('click', hideDataQualityModal);
  const dqClose2 = document.getElementById('btn-dq-close');
  if (dqClose2) dqClose2.addEventListener('click', hideDataQualityModal);
  const dqExport = document.getElementById('btn-dq-export');
  if (dqExport) dqExport.addEventListener('click', exportDataQualityReport);
  const dqAcceptAll = document.getElementById('btn-dq-accept-all');
  if (dqAcceptAll) dqAcceptAll.addEventListener('click', ()=>{
    if(confirm('This will accept all inferred testament/gender values and remove their inferred flags. A backup of flagged records will be downloaded first. Proceed?')){
      acceptAllInferred();
    }
  });

  // Candidate load/export controls (Wikidata review)
  const btnLoadCandidates = document.getElementById('btn-load-candidates');
  if(btnLoadCandidates) btnLoadCandidates.addEventListener('click', ()=>{ loadCandidatesForReview(); });
  const btnExportAccepted = document.getElementById('btn-export-accepted');
  if(btnExportAccepted) btnExportAccepted.addEventListener('click', ()=>{ exportAcceptedCandidates(); });

  const peClose = document.getElementById('btn-person-editor-close');
  if (peClose) peClose.addEventListener('click', hidePersonEditor);
  const peCancel = document.getElementById('btn-person-cancel');
  if (peCancel) peCancel.addEventListener('click', (e)=>{ e.preventDefault(); hidePersonEditor(); });
  const peSave = document.getElementById('btn-person-save');
  if (peSave) peSave.addEventListener('click', (e)=>{ e.preventDefault(); savePersonFromEditor(); });
  
  // Settings persistence
  difficultySel.addEventListener('change', saveSettingsFromUI);
  numQuestionsInput.addEventListener('change', saveSettingsFromUI);
  timeLimitInput.addEventListener('change', saveSettingsFromUI);
  
  // Language selector
  languageSelect.addEventListener('change', (e) => {
    const lang = e.target.value;
    // Persist preferred language as part of settings as well
    const settings = loadSettings() || {};
    settings.language = lang;
    try{ localStorage.setItem('settings', JSON.stringify(settings)); }catch(_){/* ignore */}
    setLanguage(lang);
    // Re-render visible question if any
    if(state.current){
      // Rebuild prompt with translated pieces when possible
      const q = state.current;
      // We cannot perfectly rebuild dynamic tokens here without source data; keep prompt as-is,
      // but refresh choices labels and status/headers via updateAllText called by setLanguage.
      // Future: store raw tokens to fully re-localize prompt.
      // Refresh answers display text
      const nodes = Array.from(document.querySelectorAll('#answers .ans'));
      nodes.forEach(node=>{
        const orig = node.dataset.value;
        const q = state.current;
        node.innerText = (typeof translateAnswerForQuestionType==='function') ? translateAnswerForQuestionType(q.type, orig) : orig;
      });
    }
  });
  
  // Theme toggle: cycle between day and night
  if (btnTheme) {
    btnTheme.addEventListener('click', ()=>{
      console.log('Theme button clicked!'); // Debug
      console.log('Current state.theme:', state.theme); // Debug
      console.log('Body classes:', document.body.className); // Debug
      
      // Use state.theme as the source of truth
      const current = state.theme || 'night';
      const next = current === 'night' ? 'day' : 'night';
      
      console.log('Switching from', current, 'to', next); // Debug
      applyTheme(next);
      saveSettingsFromUI();
    });
  } else {
    console.log('btnTheme not found!'); // Debug
  }
  // Share
  if (btnShare) {
    btnShare.addEventListener('click', async ()=>{
      const shareData = {
        title: 'Who-Bible',
        text: getText('brandDesc'),
        url: location.href
      };
      if (navigator.share) {
        try { await navigator.share(shareData); } catch(_){}
      } else {
        try {
          await navigator.clipboard.writeText(`${shareData.title} — ${shareData.url}`);
          showToast({ title: getText('exportSuccess'), msg: getText('exportMsg'), type: 'success', timeout: 1500 });
        } catch(_) {
          showToast({ title: getText('importError'), msg: 'Clipboard unavailable', type: 'error', timeout: 1500 });
        }
      }
    });
  }
  // Community placeholder behavior
  // Community opens in a new tab via anchor href
  
  // Modal handlers
  btnSummaryClose.addEventListener('click', hideSummaryModal);
  btnPlayAgain.addEventListener('click', ()=>{ hideSummaryModal(); showSetup(); });
  btnPlayersClose.addEventListener('click', hidePlayersModal);
  btnPlayersCancel.addEventListener('click', hidePlayersModal);
  btnPlayersStart.addEventListener('click', startChallengeFromModal);
  
  // Keyboard navigation on answers
  answersEl.addEventListener('keydown', onAnswersKeyDown);

}

// =========================
// Panel Management
// =========================
function showSetup(){
  setupPanel.style.display = 'flex';
  gameArea.style.display = 'none';
  studyPanel.style.display = 'none';
  stopTimer();
  // Reset quiz display
  const quizEl = document.getElementById('quiz');
  const welcomeMsg = document.getElementById('welcome-message');
  if(quizEl) quizEl.style.display = 'none';
  if(welcomeMsg) welcomeMsg.style.display = 'block';
  // Reset question number display
  if(typeof qnumEl !== 'undefined' && typeof qtotalEl !== 'undefined') {
    qnumEl.innerText = '0';
    // set total to selected number of questions for clarity
    const selected = parseInt(numQuestionsInput.value)||10;
    qtotalEl.innerText = String(selected);
  }
}

function showGame(){
  setupPanel.style.display = 'none';
  gameArea.style.display = 'flex';
  studyPanel.style.display = 'none';
}

function showStudy(){
  setupPanel.style.display = 'none';
  gameArea.style.display = 'none';
  studyPanel.style.display = 'flex';
  renderPeopleList();
  // Refresh dataset audit when Study panel is opened
  try{ renderDatasetStats(); }catch(_){/* ignore if not available */}
}

// Community removed from main SPA; use community.html

// Community helpers
// Community modal lives on community.html

function initialsFromName(name){
  const parts = (name||'').trim().split(/[\s-]+/).filter(Boolean);
  if(parts.length===0) return 'WB';
  const first = parts[0][0] || '';
  const second = parts.length>1 ? parts[1][0] : '';
  return (first+second).toUpperCase();
}
function generateAvatarText(name){
  const txt = initialsFromName(name);
  return txt || 'WB';
}
// Avatar helpers moved to community.js
// Profile helpers moved to community.js

function escapeHtml(s){
  return String(s).replace(/[&<>"]+/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[ch]));
}

// setActiveCommunityTab moved to community.js

// =========================
// Modes
// =========================
function startSolo(){
  showGame();
  gameTitle.textContent = getText('soloMode');
  prepareQuiz('solo');
  showToast({ title: getText('soloStart'), msg: getText('soloStartMsg'), type: 'info' });
}

function startTimed(){
  showGame();
  gameTitle.textContent = getText('timedMode');
  prepareQuiz('timed');
  const secs = parseInt(timeLimitInput.value)||60;
  showToast({ title: getText('timedStart'), msg: getText('timedStartMsg'), type: 'warn' });
}

function startChallenge(){
  showPlayersModal();
}

function startChallengeFromModal(){
  const name1 = (p1NameInput.value||'P1').trim() || 'P1';
  const name2 = (p2NameInput.value||'P2').trim() || 'P2';
  hidePlayersModal();
  showGame();
  gameTitle.textContent = getText('challengeMode');
  state.players = [ { name: name1, score: 0 }, { name: name2, score: 0 } ];
  state.currentPlayerIndex = 0;
  currentPlayerEl.textContent = '1';
  p1ScoreEl.textContent = '0';
  p2ScoreEl.textContent = '0';
  prepareQuiz('challenge');
  showToast({ title: getText('challengeStart'), msg: getText('challengeStartMsg'), type: 'info' });
}

function startStudy(){
  showStudy();
  showToast({ title: getText('studyStart'), msg: getText('studyStartMsg'), type: 'info' });
}

function prepareQuiz(mode){
  state.mode = mode;
  afterRef.innerText='';
  state.score = 0; state.streak = 0; state.qnum = 0; state.results = []; state.paused = false;
  const count = parseInt(numQuestionsInput.value) || 10;
  const difficulty = difficultySel.value;
  state.questions = pickQuestionSet(count, difficulty);
  state.qtotal = state.questions.length;
  qtotalEl.innerText = state.qtotal;
  scoreEl.innerText = state.score;
  streakEl.innerText = state.streak;
  btnNext.disabled = true;
  
  // Show the quiz interface
  quizEl.style.display = 'block';
  
  // Hide welcome message and show quiz content
  const welcomeMsg = document.getElementById('welcome-message');
  if(welcomeMsg) welcomeMsg.style.display = 'none';
  
  // Configure mode-specific elements
  timerEl.style.display = (mode==='timed') ? 'inline-flex' : 'none';
  btnPause.style.display = (mode==='timed') ? 'inline-block' : 'none';
  challengeStatusEl.style.display = (mode==='challenge') ? 'inline-flex' : 'none';
  
  if(mode==='timed'){
    const secs = parseInt(timeLimitInput.value) || 60;
    startTimer(secs);
    scheduleTimeWarnings();
  } else {
    stopTimer();
  }
  nextQuestion();
}

function quitQuiz(){
  showSetup();
}

// =========================
// Questions
// =========================
function pickQuestionSet(count, difficulty){
  const types = ['whoDid','whoMother','occupation','age','event'];
  let pool = filterPeopleByDifficulty(state.people, difficulty);
  // Apply testament/gender filters from UI/settings
  try{
    const testament = (testamentSelect && testamentSelect.value) ? testamentSelect.value : (loadSettings()?.testament || 'all');
    const gender = (genderSelect && genderSelect.value) ? genderSelect.value : (loadSettings()?.gender || 'all');
    if(testament && testament!=='all'){
      pool = pool.filter(p=> (p.testament ? p.testament===testament : inferTestament(p)===testament));
    }
    if(gender && gender!=='all'){
      pool = pool.filter(p=> (p.gender ? p.gender===gender : inferGender(p)===gender));
    }
  }catch(_){ }
  shuffle(pool);
  const selected = pool.slice(0, Math.min(count, pool.length));
  const questions = [];
  for(const person of selected){
    const t = types[Math.floor(Math.random()*types.length)];
    if(t==='whoDid'){
      const rawEvent = person.notable_events?.[0] || getText('fallbackEvent');
      // Store raw token to allow re-localization on language change
      const event = translateEvent(rawEvent);
      questions.push({type:'whoDid',prompt:getText('questionWhoDid', {event}),answer:person.name,ref:person.verses, raw:{ event: rawEvent }});
    }else if(t==='whoMother'){
      if(person.mother) questions.push({type:'whoMother',prompt:getText('questionWhoMother', {name: person.name}),answer:person.mother,ref:person.verses, raw:{ name: person.name }});
    }else if(t==='occupation'){
      if(person.occupation) questions.push({type:'occupation',prompt:getText('questionOccupation', {name: person.name}),answer:person.occupation,ref:person.verses, raw:{ occupation: person.occupation, name: person.name }});
    }else if(t==='age'){
      if(person.age_notes) questions.push({type:'age',prompt:getText('questionAge', {name: person.name}),answer:person.age_notes,ref:person.verses, raw:{ name: person.name, age: person.age_notes }});
    }else if(t==='event'){
      if(person.notable_events && person.notable_events.length>0) {
        const rawEvent = person.notable_events[0];
        const event = translateEvent(rawEvent);
        questions.push({type:'event',prompt:getText('questionEvent', {event}),answer:person.name,ref:person.verses, raw:{ event: rawEvent }});
      }
    }
  }
  // ensure we have at least count questions; fill with simple ones
  let i = 0;
  while(questions.length < count && i < state.people.length){
    const p = state.people[i++];
    const rawEvent = p.notable_events?.[0] || getText('fallbackEvent');
    const event = translateEvent(rawEvent);
    questions.push({type:'whoDid',prompt:getText('questionWhoDid', {event}),answer:p.name,ref:p.verses});
  }
  return questions.slice(0, count);
}

function filterPeopleByDifficulty(people, difficulty){
  if(difficulty==='easy'){
    const common = new Set(['Noah','Moses','David','Solomon','Abraham','Isaac','Jacob','Ruth','Esther','Peter','Paul','Mary (mother of Jesus)','John the Baptist','Joseph (son of Jacob)','Lazarus']);
    return people.filter(p=>common.has(p.name));
  }
  if(difficulty==='hard'){
    // Prefer entries with less-complete bios (harder), but include all
    const scored = people.map(p=>({
      p,
      score: (p.occupation?0:1) + (p.mother?0:1) + (p.age_notes?0:1) + ((p.notable_events?.length||0) < 1 ? 1 : 0)
    }));
    scored.sort((a,b)=>b.score-a.score);
    return scored.map(s=>s.p);
  }
  return people.slice();
}

// Heuristics: determine testament and gender from available data if explicit fields missing
function inferTestament(p){
  if(!p) return null;
  if(p.testament) return p.testament; // 'ot' or 'nt'
  // Look at verse keys to guess NT vs OT
  try{
    const ntKeys = ['Matthew','Mark','Luke','John','Acts','Romans','Corinthians','Galatians','Ephesians','Philippians','Colossians','Thessalonians','Timothy','Titus','Philemon','Hebrews','James','Peter','Jude','Revelation'];
    const verses = (p.verses||[]).join(' ');
    for(const k of ntKeys){ if(verses.includes(k)) return 'nt'; }
  }catch(_){ }
  return 'ot';
}

function inferGender(p){
  if(!p) return null;
  if(p.gender) return p.gender; // 'male' or 'female'
  const femaleNames = new Set(['mary','martha','esther','ruth','rebekah','leah','rachel','hannah','naomi','abigail','joanna','salome','sarah']);
  const nm = (p.name||'').toLowerCase();
  for(const fn of femaleNames){ if(nm.includes(fn)) return 'female'; }
  // fallback: if has mother field, likely male or female, but default to male
  return 'male';
}

function nextQuestion(){
  if(state.qnum >= state.qtotal){ endQuiz(); return; }
  state.current = state.questions[state.qnum];
  state.qnum++;
  qnumEl.innerText = state.qnum;
  scoreEl.innerText = state.score;
  streakEl.innerText = state.streak;
  renderQuestion(state.current);
  updateProgress();
}

function renderQuestion(q){
  // If the question has raw tokens, regenerate localized prompt to respect current language
  if(q && q.raw){
    if(q.type==='whoDid' || q.type==='event'){
      const ev = translateEvent(q.raw.event);
      qText.innerText = getText(q.type==='whoDid' ? 'questionWhoDid' : 'questionEvent', { event: ev });
    } else if(q.type==='occupation'){
      qText.innerText = getText('questionOccupation', { name: q.raw.name });
    } else if(q.type==='whoMother'){
      qText.innerText = getText('questionWhoMother', { name: q.raw.name });
    } else if(q.type==='age'){
      qText.innerText = getText('questionAge', { name: q.raw.name });
    } else {
      qText.innerText = q.prompt;
    }
  } else {
    qText.innerText = q.prompt;
  }
  afterRef.innerText='';
  btnNext.disabled = true;
  answersEl.innerHTML='';
  answersEl.setAttribute('aria-activedescendant','');
  answersEl.setAttribute('aria-label', getText('answersLabel'));
  const choices = makeChoices(q);
  choices.forEach((choiceObj, idx)=>{
    const div = document.createElement('div');
    div.className='ans';
    div.tabIndex=0;
    div.id = `choice-${idx+1}`;
    div.setAttribute('role','option');
    div.setAttribute('aria-selected','false');
    div.innerText = choiceObj.display;
    div.dataset.value = choiceObj.original;
    div.addEventListener('click',()=>handleAnswer(choiceObj.original,q,div));
    answersEl.appendChild(div);
  });
  // Focus first choice for accessibility
  const first = answersEl.querySelector('.ans');
  if(first) first.focus();
}

function makeChoices(q){
  const set = new Set([q.answer]);
  const distractors = getDistractors(q);
  for(const d of distractors){
    set.add(d);
    if(set.size>=4) break;
  }
  // Fallback to names if not enough
  const names = state.people.map(p=>p.name);
  while(set.size<4){
    const pick = names[Math.floor(Math.random()*names.length)];
    set.add(pick);
  }
  const arr = Array.from(set).map(original=>({ original, display: translateAnswerForQuestionType(q.type, original) }));
  shuffle(arr);
  return arr;
}

function getDistractors(q){
  const results = [];
  if(q.type==='occupation'){
    const pool = state.people.map(p=>p.occupation).filter(Boolean).filter(x=>normalize(x)!==normalize(q.answer));
    shuffle(pool); results.push(...pool);
  } else if(q.type==='age'){
    const pool = state.people.map(p=>p.age_notes).filter(Boolean).filter(x=>normalize(x)!==normalize(q.answer));
    shuffle(pool); results.push(...pool);
  } else if(q.type==='whoMother'){
    const pool = state.people.map(p=>p.mother).filter(Boolean).filter(x=>normalize(x)!==normalize(q.answer));
    shuffle(pool); results.push(...pool);
  } else {
    const pool = state.people.map(p=>p.name).filter(x=>normalize(x)!==normalize(q.answer));
    shuffle(pool); results.push(...pool);
  }
  return results;
}

function handleAnswer(choice,q, el){
  // Disable further answers; mark correctness
  const correct = normalize(choice) === normalize(q.answer);
  const ansNodes = Array.from(answersEl.querySelectorAll('.ans'));
  ansNodes.forEach(node=>{
    node.classList.add('disabled');
  if(normalize(node.dataset.value) === normalize(q.answer)) node.classList.add('correct');
  });
  if(!correct) el.classList.add('incorrect');

  // Visual feedback simplified (no animations)

  if(correct){
    state.score += 10;
    state.streak += 1;
  afterRef.innerText = `${getText('correctAnswer')} — ${getText('references')}: ` + (q.ref||[]).join(', ');
    if(state.mode==='challenge'){
      state.players[state.currentPlayerIndex].score += 10;
      updateChallengeScores();
    }
    showToast({ title: getText('correctAnswer'), msg: getText('correctMsg'), type: 'success', timeout: 1500 });
  }else{
    state.streak = 0;
  afterRef.innerText = `${getText('wrongAnswer')}. ${getText('correctLabel')}: ${translateAnswerForQuestionType(q.type, q.answer)}. ${getText('references')}: ${(q.ref||[]).join(', ')}`;
  showToast({ title: getText('wrongAnswer'), msg: getText('wrongMsg', { answer: translateAnswerForQuestionType(q.type, q.answer) }), type: 'error', timeout: 1800 });
  }

  scoreEl.innerText = state.score;
  streakEl.innerText = state.streak;

  // Record result
  state.results.push({ 
    prompt: q.prompt, 
    chosen: choice, 
    correctAnswer: q.answer, 
    chosenDisplay: translateAnswerForQuestionType(q.type, choice),
    correctDisplay: translateAnswerForQuestionType(q.type, q.answer),
    correct, 
    ref: q.ref||[] 
  });

  // For challenge mode, alternate player each question
  if(state.mode==='challenge'){
    state.currentPlayerIndex = (state.currentPlayerIndex + 1) % 2;
    currentPlayerEl.textContent = String(state.currentPlayerIndex + 1);
    const nextName = state.players[state.currentPlayerIndex].name;
    showToast({ title: getText('challengeTurn', { player: nextName }), msg: getText('challengeTurnMsg', { player: nextName }), type: 'info', timeout: 1200 });
  }

  btnNext.disabled = false;
}

function updateChallengeScores(){
  p1ScoreEl.textContent = String(state.players[0].score);
  p2ScoreEl.textContent = String(state.players[1].score);
}

function endQuiz(){
  let endText = `${getText('quizComplete')}! ${getText('yourScore')}: ${state.score}`;
  if(state.mode==='challenge'){
    const [p1,p2] = state.players;
    const isTie = p1.score === p2.score;
    const winnerName = p1.score > p2.score ? p1.name : p2.name;
    endText += ` — ${isTie ? getText('tieGame') : getText('winner') + ': ' + winnerName}`;
  }
  qText.innerText = endText;
  answersEl.innerHTML='';
  afterRef.innerText='';
  stopTimer();
  
  // Update player statistics
  const correctAnswers = state.results.filter(r => r.correct).length;
  const totalQuestions = state.results.length;
  updatePlayerStats(state.score, state.streak, correctAnswers, totalQuestions, state.mode);
  
  state.current=null; state.questions=[]; state.qnum=0; state.qtotal=0;
  btnNext.disabled = true;

  // Show summary modal
  showSummaryModal();
  showToast({ title: getText('quizComplete'), msg: `${getText('yourScore')}: ${state.score}${state.mode==='challenge'?`. ${winnerText()}`:''}`, type: 'success', timeout: 5000 });
}

function winnerText(){
  const [p1,p2] = state.players;
  if(p1.score===p2.score) return getText('tieGame');
  return `${getText('winner')}: ${p1.score>p2.score?p1.name:p2.name}`;
}

// =========================
// Timer
// =========================
function startTimer(seconds){
  stopTimer();
  state.timerSecondsRemaining = seconds;
  timeRemainingEl.textContent = String(state.timerSecondsRemaining);
  timerEl.style.display = 'inline-flex';
  state.timerId = setInterval(()=>{
    if(state.paused) return;
    state.timerSecondsRemaining -= 1;
    timeRemainingEl.textContent = String(Math.max(0, state.timerSecondsRemaining));
    // Timer styling thresholds
    timerEl.classList.remove('warn','danger');
    if(state.timerSecondsRemaining <= 5) timerEl.classList.add('danger');
    else if(state.timerSecondsRemaining <= 15) timerEl.classList.add('warn');
    if(state.timerSecondsRemaining <= 0){
      stopTimer();
  showToast({ title: getText('timeUp'), msg: getText('timeUpMsg'), type: 'warn', timeout: 2000 });
      endQuiz();
    }
  },1000);
}

function stopTimer(){
  if(state.timerId){
    clearInterval(state.timerId);
    state.timerId = null;
  }
}

function togglePause(){
  if(state.mode!=='timed') return;
  state.paused = !state.paused;
  btnPause.textContent = state.paused ? getText('resume') : getText('pause');
  showToast({ title: state.paused ? getText('paused') : getText('resumed'), msg: state.paused ? getText('timerPaused') : getText('timerRunning'), type: 'info', timeout: 1200 });
}

// =========================
// Study/Lookup
// =========================
function renderPeopleList(filter){
  peopleList.innerHTML='';
  let arr = state.people.filter(p=>!filter || p.name.toLowerCase().includes(filter.toLowerCase()));
  // Populate mother-select options dynamically (unique mother names)
  try{
    if(motherSelect){
      const mothers = Array.from(new Set(state.people.map(pp=>pp.mother).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      motherSelect.innerHTML = '<option value="">All mothers</option>' + mothers.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
    }
  }catch(_){ /* ignore */ }
  // Filter by selected mother if one chosen
  try{
    if(motherSelect && motherSelect.value){
      arr = arr.filter(p=>p.mother === motherSelect.value);
    }
  }catch(_){ }
  // Apply testament/gender filters to study list as well
  try{
    const testament = (testamentSelect && testamentSelect.value) ? testamentSelect.value : 'all';
    const gender = (genderSelect && genderSelect.value) ? genderSelect.value : 'all';
    if(testament && testament!=='all') arr = arr.filter(p=> (p.testament? p.testament===testament : inferTestament(p)===testament));
    if(gender && gender!=='all') arr = arr.filter(p=> (p.gender? p.gender===gender : inferGender(p)===gender));
  }catch(_){ }
  if(filterMother?.checked) arr = arr.filter(p=>!!p.mother);
  if(filterOccupation?.checked) arr = arr.filter(p=>!!p.occupation);
  if(filterAge?.checked) arr = arr.filter(p=>!!p.age_notes);
  if(sortSelect){
    if(sortSelect.value==='name-asc') arr.sort((a,b)=>a.name.localeCompare(b.name));
    if(sortSelect.value==='name-desc') arr.sort((a,b)=>b.name.localeCompare(a.name));
  }
  if(peopleCountEl) peopleCountEl.textContent = String(arr.length);
  for(const p of arr){
    const item = document.createElement('div');
    item.className = 'person-item';
    const header = document.createElement('div');
    header.className = 'person-header';
    header.innerHTML = `<div style="display:flex;align-items:center;gap:12px"><div class=\"person-title\"><strong>${escapeHtml(p.name)}</strong></div><div class=\"muted\">${escapeHtml((p.short_bio||'').slice(0,80))}</div></div>`;
    const details = document.createElement('div');
    details.className = 'person-details';
    // Default visibility respects the global "show details" toggle
    try{
      details.style.display = (showDetailsToggle && showDetailsToggle.checked) ? 'block' : 'none';
    }catch(_){ details.style.display = 'none'; }
    const aliasLabel = getText('aliases');
    const motherLabel = getText('filterMother');
    const occupationLabel = getText('filterOccupation');
    const ageLabel = getText('filterAge');
    const eventsLabel = getText('events');
    const versesLabel = getText('verses');
    const eventsJoined = (p.notable_events||[]).map(translateEvent).join(', ');
    // Build details content; include relatives if requested
    const parts = [];
    if(p.aliases?.length) parts.push(`<div><strong>${aliasLabel}:</strong> ${escapeHtml(p.aliases.join(', '))}</div>`);
    if(p.mother) parts.push(`<div class=\"mother-line\"><strong>${motherLabel}:</strong> ${escapeHtml(p.mother)}</div>`);
    if(p.occupation) parts.push(`<div><strong>${occupationLabel}:</strong> ${escapeHtml(p.occupation)}</div>`);
    if(p.age_notes) parts.push(`<div><strong>${ageLabel}:</strong> ${escapeHtml(p.age_notes)}</div>`);
    if(p.notable_events?.length) parts.push(`<div><strong>${eventsLabel}:</strong> ${escapeHtml(eventsJoined)}</div>`);
    parts.push(`<div class=\"ref\"><strong>${versesLabel}:</strong> ${escapeHtml(p.verses?.join(', ')||'')}</div>`);

    // Relatives: siblings (same mother) and children (people who list this person as mother)
    let relativesHtml = '';
    try{
      if(showRelativesToggle && showRelativesToggle.checked){
        const siblings = state.people.filter(pp=>pp.mother && p.mother && pp.mother===p.mother && pp.name!==p.name).map(s=>s.name);
        const children = state.people.filter(pp=>pp.mother && pp.mother===p.name).map(c=>c.name);
        relativesHtml += '<div class="relatives-block">';
        if(siblings.length) relativesHtml += `<div><strong>Siblings:</strong> ${escapeHtml(siblings.join(', '))}</div>`;
        if(children.length) relativesHtml += `<div><strong>Children:</strong> ${escapeHtml(children.join(', '))}</div>`;
        if(!siblings.length && !children.length) relativesHtml += `<div class=\"muted\">No direct relatives listed</div>`;
        relativesHtml += '</div>';
      }
    }catch(_){ }

    details.innerHTML = parts.join('') + relativesHtml;
    header.addEventListener('click',()=>{
      details.style.display = details.style.display==='none' ? 'block' : 'none';
    });
    // Add an explicit details toggle button for accessibility and a family crest
    const detailsBtn = document.createElement('button');
    detailsBtn.className = 'details-btn';
    detailsBtn.type = 'button';
    detailsBtn.setAttribute('aria-expanded', details.style.display==='block');
    detailsBtn.textContent = details.style.display==='block' ? 'Hide' : 'Show';
    detailsBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); const isShown = details.style.display==='block'; details.style.display = isShown ? 'none' : 'block'; detailsBtn.textContent = isShown ? 'Show' : 'Hide'; detailsBtn.setAttribute('aria-expanded', !isShown); });

    const crest = document.createElement('div');
    crest.className = 'family-crest';
    try{
      const motherName = p.mother || '';
      const motherInitials = motherName ? initialsFromName(motherName) : '—';
      const siblingCount = state.people.filter(pp=>pp.mother && pp.mother===p.mother).length - 1;
      const childrenCount = state.people.filter(pp=>pp.mother && pp.mother===p.name).length;
      crest.innerHTML = `<div class=\"crest-initials\">${escapeHtml(motherInitials)}</div><div class=\"crest-meta\"><div class=\"crest-line\">${motherName?escapeHtml(motherName):'<span class="muted">No mother</span>'}</div><div class=\"crest-line muted\">Siblings: ${siblingCount>0?siblingCount:0} • Children: ${childrenCount}</div></div>`;
    }catch(_){ crest.textContent = ''; }

    item.appendChild(crest);
    item.appendChild(header);
    item.appendChild(details);
    // Place details toggle in header for compact layout
    header.appendChild(detailsBtn);
    peopleList.appendChild(item);
  }
  // Ensure the dataset audit reflects the latest people data (full dataset)
  try{ renderDatasetStats(); }catch(_){/* ignore if not present */}
}

function toggleAllDetails(expand){
  const items = peopleList.querySelectorAll('.person-details');
  items.forEach(el=>{ el.style.display = expand ? 'block' : 'none'; });
}

// =========================
// Dataset Audit (Study panel)
// =========================
function computeDatasetStats(people){
  const stats = {
    total: 0,
    withEvents: 0,
    withOccupation: 0,
    withMother: 0,
    withAliases: 0,
    withAge: 0,
    withVerses: 0
  };
  if(!Array.isArray(people)) return stats;
  stats.total = people.length;
  for(const p of people){
    if(p.notable_events && Array.isArray(p.notable_events) && p.notable_events.length>0) stats.withEvents++;
    if(p.occupation) stats.withOccupation++;
    if(p.mother) stats.withMother++;
    if(p.aliases && Array.isArray(p.aliases) && p.aliases.length>0) stats.withAliases++;
    if(p.age_notes) stats.withAge++;
    if(p.verses && Array.isArray(p.verses) && p.verses.length>0) stats.withVerses++;
  }
  return stats;
}

function renderDatasetStats(){
  try{
    const elTotal = document.getElementById('audit-total');
    const elEvents = document.getElementById('audit-events');
    const elOcc = document.getElementById('audit-occupation');
    const elMother = document.getElementById('audit-mother');
    const elAliases = document.getElementById('audit-aliases');
    const elAge = document.getElementById('audit-age');
    if(!elTotal) return; // not on page
    const stats = computeDatasetStats(state.people || []);
    elTotal.textContent = String(stats.total);
    elEvents.textContent = String(stats.withEvents);
    elOcc.textContent = String(stats.withOccupation);
    elMother.textContent = String(stats.withMother);
    elAliases.textContent = String(stats.withAliases);
    elAge.textContent = String(stats.withAge);
  }catch(_){ /* non-fatal */ }
}

// =========================
// Data Quality & Person Editor
// =========================
function showDataQualityModal(){
  const modal = document.getElementById('data-quality-modal');
  if(!modal) return;
  renderDataQualityReport();
  modal.style.display = 'flex';
}

function hideDataQualityModal(){
  const modal = document.getElementById('data-quality-modal');
  if(!modal) return;
  modal.style.display = 'none';
}

function renderDataQualityReport() {
    const total = state.people.length;
    const inferredTestament = state.people.filter(p => p._inferred_testament && !p._verified).length;
    const inferredGender = state.people.filter(p => p._inferred_gender && !p._verified).length;
    const forReview = state.people.filter(p => p._for_review && !p._verified).length;

    const summaryEl = document.getElementById('data-quality-summary');
    summaryEl.innerHTML = `
        <p><strong>Total People:</strong> ${total}</p>
        <p><strong class="inferred">Unverified Inferred Testaments:</strong> ${inferredTestament}</p>
        <p><strong class="inferred">Unverified Inferred Genders:</strong> ${inferredGender}</p>
        <p><strong class="review">New from Wikidata for Review:</strong> ${forReview}</p>
    `;

    const listEl = document.getElementById('data-quality-list');
    listEl.innerHTML = '';

    state.people.forEach((person, index) => {
        let flags = '';
        if (person._inferred_testament && !person._verified) flags += '<span class="flag inferred">Inferred Testament</span>';
        if (person._inferred_gender && !person._verified) flags += '<span class="flag inferred">Inferred Gender</span>';
        if (person._for_review && !person._verified) flags += '<span class="flag review">For Review</span>';


        if (flags) {
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="person-info">
                    <span class="person-name">${person.name}</span>
                    <div class="flags">${flags}</div>
                </div>
                <button class="btn-edit-person" data-index="${index}">Review/Edit</button>
            `;
            listEl.appendChild(li);
        }
    });
}

// -------------------------
// Candidate review (Wikidata) helpers
// -------------------------
async function loadCandidatesForReview(){
  // Try to fetch a prepared candidate file from tools/ (served by static server)
  try{
    const resp = await fetch('tools/people_from_wikidata.candidates.relaxed.json');
    if(!resp.ok) throw new Error('Fetch failed');
    const data = await resp.json();
    // annotate and store
    state.candidates = (Array.isArray(data) ? data : []).map((c, i)=>({ _local_index: i, _for_review: true, _rejected: false, ...c }));
    state.acceptedCandidates = [];
    renderCandidatesList();
    renderDataQualityReport();
    showToast({ title: 'Candidates loaded', msg: `${state.candidates.length} candidate(s) loaded.`, type: 'success', timeout: 2200 });
  }catch(err){
    console.error('Could not load candidates:', err);
    showToast({ title: 'Load failed', msg: 'Could not load candidate file. Ensure you are running a local server and the file exists at tools/people_from_wikidata.candidates.relaxed.json', type: 'error', timeout: 5000 });
  }
}

function renderCandidatesList(){
  const listEl = document.getElementById('data-quality-list');
  if(!listEl) return;
  listEl.innerHTML = '';
  if(!state.candidates || state.candidates.length===0){
    listEl.innerHTML = '<p class="muted">No candidates loaded. Use "Load Candidates" to fetch proposals.</p>';
    return;
  }

  const ul = document.createElement('ul'); ul.className = 'dq-candidates';
  state.candidates.forEach((c, idx)=>{
    if(c._rejected) return; // skip rejected ones
    const li = document.createElement('li');
    const wikilink = c._qid ? `https://www.wikidata.org/wiki/${c._qid}` : (c._source||'');
    li.innerHTML = `
      <div class="candidate-head">
        <strong>${escapeHtml(c.name||'Unnamed')}</strong>
        <span class="muted">${c._qid?escapeHtml(c._qid):''}</span>
      </div>
      <div class="candidate-body">
        <div>${escapeHtml(c.short_bio||c.note||'')}</div>
        <div class="meta muted">Source: ${escapeHtml(wikilink)}</div>
      </div>
      <div class="candidate-actions" style="margin-top:6px">
        <button class="btn-accept" data-idx="${idx}">Accept</button>
        <button class="btn-reject" data-idx="${idx}">Reject</button>
      </div>
    `;
    ul.appendChild(li);
  });
  listEl.appendChild(ul);

  // Wire accept/reject buttons
  Array.from(listEl.querySelectorAll('.btn-accept')).forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const idx = parseInt(e.target.dataset.idx,10);
      acceptCandidate(idx);
    });
  });
  Array.from(listEl.querySelectorAll('.btn-reject')).forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const idx = parseInt(e.target.dataset.idx,10);
      rejectCandidate(idx);
    });
  });
}

function acceptCandidate(idx){
  const cand = state.candidates?.[idx];
  if(!cand) return;
  // Prepare object to merge into people; preserve provenance
  const obj = { ...cand };
  delete obj._local_index; delete obj._for_review; delete obj._rejected;
  obj._qid = cand._qid || cand._source || null;
  obj._verified = true; obj._accepted_date = (new Date()).toISOString();
  // Validate before pushing
  const v = validatePerson(obj);
  if(!v.valid){
    // still allow accept but warn
    if(!confirm('Candidate failed validation: '+v.reason+"\nAccept anyway?")) return;
  }
  state.people.push(obj);
  state.acceptedCandidates.push(obj);
  // mark candidate as processed
  state.candidates[idx]._rejected = true;
  savePeopleDataToLocalStorage(state.people);
  renderPeopleList(); renderDatasetStats(); renderDataQualityReport(); renderCandidatesList();
  showToast({ title: 'Accepted', msg: `${obj.name} added to dataset`, type: 'success', timeout: 2000 });
}

function rejectCandidate(idx){
  const cand = state.candidates?.[idx];
  if(!cand) return;
  if(!confirm('Reject candidate '+(cand.name||'Unnamed')+'? This cannot be undone in this session.')) return;
  state.candidates[idx]._rejected = true;
  renderCandidatesList(); renderDataQualityReport();
}

function exportAcceptedCandidates(){
  const arr = state.acceptedCandidates || [];
  if(arr.length===0){ showToast({ title: 'No accepted', msg: 'No accepted candidates to export', type: 'info' }); return; }
  const json = JSON.stringify(arr, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'accepted_candidates.json'; a.click(); URL.revokeObjectURL(url);
  showToast({ title: 'Exported', msg: `Downloaded ${arr.length} accepted candidate(s)`, type: 'success', timeout: 2200 });
}

function exportDataQualityReport() {
  // Export subset with inferred or missing fields
  const people = state.people || [];
  const flagged = people.filter(p=>(!p.testament || p._inferred_testament) || (!p.gender || p._inferred_gender));
  const json = JSON.stringify(flagged, null, 2);
  const blob = new Blob([json],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'data_quality_report.json'; a.click(); URL.revokeObjectURL(url);
}

let __who_edit_index = -1;
function showPersonEditor(idx){
  const modal = document.getElementById('person-editor-modal');
  if(!modal) return;
  const person = state.people?.[idx];
  __who_edit_index = idx;
  if(person){
    document.getElementById('edit-name').value = person.name || '';
    document.getElementById('edit-aliases').value = (person.aliases||[]).join(', ');
    document.getElementById('edit-mother').value = person.mother || '';
    document.getElementById('edit-occupation').value = person.occupation || '';
    document.getElementById('edit-age').value = person.age_notes || '';
    document.getElementById('edit-events').value = (person.notable_events||[]).join('\n');
    document.getElementById('edit-verses').value = (person.verses||[]).join(', ');
    document.getElementById('edit-testament').value = person.testament || 'ot';
    document.getElementById('edit-gender').value = person.gender || 'male';
  } else {
    document.getElementById('person-editor-form').reset();
    __who_edit_index = -1;
  }
  modal.style.display = 'flex';
}

function hidePersonEditor(){
  const modal = document.getElementById('person-editor-modal');
  if(!modal) return; modal.style.display = 'none';
}

function savePersonFromEditor(){
  const idx = __who_edit_index;
  const name = document.getElementById('edit-name').value.trim();
  if(!name){ alert('Name required'); return; }
  const aliases = document.getElementById('edit-aliases').value.split(',').map(s=>s.trim()).filter(Boolean);
  const mother = document.getElementById('edit-mother').value.trim() || null;
  const occupation = document.getElementById('edit-occupation').value.trim() || null;
  const age_notes = document.getElementById('edit-age').value.trim() || null;
  const notable_events = document.getElementById('edit-events').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const verses = document.getElementById('edit-verses').value.split(',').map(s=>s.trim()).filter(Boolean);
  const testament = document.getElementById('edit-testament').value || 'ot';
  const gender = document.getElementById('edit-gender').value || 'male';

  const obj = { name, aliases, mother, occupation, age_notes, notable_events, verses, testament, gender };
  const v = validatePerson(obj);
  if(!v.valid){ alert('Validation failed: ' + v.reason); return; }
  if(idx>=0 && state.people && state.people[idx]){
    // preserve any other fields like short_bio
    const orig = state.people[idx];
    state.people[idx] = { ...orig, ...obj };
    // clear inference flags if user explicitly set values
    delete state.people[idx]._inferred_testament; delete state.people[idx]._inferred_gender;
    state.people[idx]._verified = true;
  } else {
    state.people.push(obj);
  }
  savePeopleDataToLocalStorage(state.people);
  renderPeopleList(); renderDatasetStats(); renderDataQualityReport();
  hidePersonEditor();
}

/** Bulk accept inferred fields across the dataset
 * - Backs up flagged records as a JSON download
 * - Removes `_inferred_testament` and `_inferred_gender` from those records and marks `_verified`
 * - Saves to localStorage and refreshes UI
 */
function acceptAllInferred(){
  const people = state.people || [];
  const flagged = people.filter(p=>(!p.testament || p._inferred_testament) || (!p.gender || p._inferred_gender));
  if(flagged.length===0){ showToast({ title: 'No changes', msg: 'No inferred/missing fields found.', type: 'info' }); return; }

  // Backup flagged items
  try{
    const json = JSON.stringify(flagged, null, 2);
    const blob = new Blob([json],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    a.download = `who-bible-flagged-backup-${ts}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }catch(_){ /* continue even if download fails */ }

  // Apply accept (clear inference flags and mark verified)
  let applied = 0;
  for(const p of people){
    const should = (!p.testament || p._inferred_testament) || (!p.gender || p._inferred_gender);
    if(should){
      if(p._inferred_testament) delete p._inferred_testament;
      if(p._inferred_gender) delete p._inferred_gender;
      p._verified = true;
      applied++;
    }
  }

  savePeopleDataToLocalStorage(people);
  renderDataQualityReport();
  renderPeopleList();
  renderDatasetStats();
  showToast({ title: 'Bulk accept complete', msg: `Accepted ${applied} records. Backup downloaded.`, type: 'success', timeout: 3000 });
}

// =========================
// Import/Export & Persistence
// =========================
function exportJson(){
  const json = JSON.stringify(state.people,null,2);
  // Download as file
  const blob = new Blob([json],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='people_data.json'; a.click(); URL.revokeObjectURL(url);
  // Also try to copy to clipboard for convenience
  if(navigator && navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(json).then(()=>{
      showToast({ title: getText('exportSuccess'), msg: getText('exportMsg'), type: 'success', timeout: 1800 });
    }).catch(()=>{
      // Clipboard failed; still show download success
      showToast({ title: getText('exportSuccess'), msg: getText('exportMsg'), type: 'success', timeout: 1800 });
    });
  } else {
    showToast({ title: getText('exportSuccess'), msg: getText('exportMsg'), type: 'success', timeout: 1800 });
  }
}

async function handleImportFile(e){
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  try{
    const parsed = JSON.parse(txt);
    if(!Array.isArray(parsed)){
      showToast({ title: getText('importError'), msg: getText('importErrorMsg'), type: 'error' });
    } else {
      // Validate each item and collect errors
      const errors = [];
      const valid = [];
      parsed.forEach((item, idx)=>{
        const res = validatePerson(item);
        if(res.valid) valid.push(item);
        else errors.push(`Item ${idx+1}: ${res.reason}`);
      });
      if(errors.length){
        const msg = `${getText('importError')}: ${errors.slice(0,5).join('; ')}${errors.length>5?` (+${errors.length-5} more)`:''}`;
        showToast({ title: getText('importError'), msg, type: 'error', timeout: 5000 });
      }
      if(valid.length>0){
        state.people = valid;
        savePeopleDataToLocalStorage(valid);
        renderPeopleList();
        renderDatasetStats();
        showToast({ title: getText('importSuccess'), msg: getText('importMsg'), type: 'success' });
      }
    }
  }catch(err){
    showToast({ title: getText('importError'), msg: (err?.message||String(err)), type: 'error' });
  } finally {
    e.target.value = '';
  }
}

// Simple runtime validation for imported person objects
function validatePerson(p){
  if(!p || typeof p !== 'object') return { valid:false, reason: 'Not an object' };
  if(!p.name || typeof p.name !== 'string' || !p.name.trim()) return { valid:false, reason: 'Missing or invalid "name"' };
  if(p.aliases && !Array.isArray(p.aliases)) return { valid:false, reason: '"aliases" must be an array if present' };
  if(p.mother && typeof p.mother !== 'string') return { valid:false, reason: '"mother" must be a string if present' };
  if(p.occupation && typeof p.occupation !== 'string') return { valid:false, reason: '"occupation" must be a string if present' };
  if(p.age_notes && typeof p.age_notes !== 'string') return { valid:false, reason: '"age_notes" must be a string if present' };
  if(p.notable_events && !Array.isArray(p.notable_events)) return { valid:false, reason: '"notable_events" must be an array if present' };
  if(p.verses && !Array.isArray(p.verses)) return { valid:false, reason: '"verses" must be an array if present' };
  // short_bio optional but should be string if present
  if(p.short_bio && typeof p.short_bio !== 'string') return { valid:false, reason: '"short_bio" must be a string if present' };
  return { valid:true };
}

function resetData(){
  if(confirm(getText('resetConfirm'))){
    localStorage.removeItem('peopleData');
    state.people = DEFAULT_PEOPLE_DATA.slice();
    renderPeopleList();
    renderDatasetStats();
    showToast({ title: getText('resetSuccess'), msg: getText('resetMsg'), type: 'success' });
  }
}

function savePeopleDataToLocalStorage(arr){
  try{ localStorage.setItem('peopleData', JSON.stringify(arr)); }catch(_){/* ignore */}
}

function loadPeopleDataFromLocalStorage(){
  try{
    const txt = localStorage.getItem('peopleData');
    if(!txt) return null;
    const parsed = JSON.parse(txt);
    return Array.isArray(parsed) ? parsed : null;
  }catch(_){ return null; }
}

// =========================
// Utilities
// =========================
function normalize(s){ return (s||'').toString().trim().toLowerCase(); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} }

function onAnswersKeyDown(e){
  const items = Array.from(answersEl.querySelectorAll('.ans'));
  if(items.length===0) return;
  const idx = items.findIndex(x=>x===document.activeElement);
  if(e.key==='ArrowDown'){
    e.preventDefault();
    const next = items[(idx+1+items.length)%items.length]; next?.focus();
  }else if(e.key==='ArrowUp'){
    e.preventDefault();
    const prev = items[(idx-1+items.length)%items.length]; prev?.focus();
  }else if(e.key==='Enter'){
    e.preventDefault();
    document.activeElement?.click();
  }else if(/^[1-4]$/.test(e.key)){
    e.preventDefault();
    const num = parseInt(e.key,10);
    const target = items[num-1]; target?.click();
  }else if(e.key.toLowerCase()==='n'){
    if(!btnNext.disabled) btnNext.click();
  }else if(e.key.toLowerCase()==='q'){
    btnQuit.click();
  }
}

function updateProgress(){
  if(!progressBarEl) return;
  const answered = Math.max(0, state.qnum - 1);
  const pct = state.qtotal ? Math.round((answered / state.qtotal) * 100) : 0;
  progressBarEl.style.width = pct + '%';
}

// Theme
function applyTheme(theme){
  console.log('applyTheme called with:', theme); // Debug
  state.theme = theme;
  // Remove all theme classes first
  document.body.classList.remove('day', 'night');
  
  // Apply the new theme
  if(theme === 'day') {
    document.body.classList.add('day');
    console.log('Applied day theme'); // Debug
  } else {
    // Default to night theme
    document.body.classList.add('night');
    theme = 'night'; // Normalize to night if invalid theme
    console.log('Applied night theme'); // Debug
  }
  
  // Update theme toggle button tooltip
  const themeKey = theme === 'day' ? 'themeDay' : 'themeNight';
  const keyText = getText(themeKey) || (theme === 'day' ? 'Day' : 'Night');
  if(btnTheme) btnTheme.setAttribute('title', `Toggle theme — ${keyText}`);
}

function saveSettingsFromUI(){
  const settings = {
    difficulty: difficultySel.value,
    numQuestions: parseInt(numQuestionsInput.value)||10,
    timeLimit: parseInt(timeLimitInput.value)||60,
    theme: state.theme
  };
  try{
    if(testamentSelect) settings.testament = testamentSelect.value || 'all';
    if(genderSelect) settings.gender = genderSelect.value || 'all';
  }catch(_){ }
  try{ localStorage.setItem('settings', JSON.stringify(settings)); }catch(_){/* ignore */}
}

function loadSettings(){
  try{
    const txt = localStorage.getItem('settings');
    if(!txt) return null;
    return JSON.parse(txt);
  }catch(_){ return null; }
}

// Summary modal
function showSummaryModal(){
  if(!modalEl) return;
  const total = state.results.length;
  const correct = state.results.filter(r=>r.correct).length;
  const accuracy = total ? Math.round((correct/total)*100) : 0;
  summaryStatsEl.innerHTML = getText('summaryStats', { score: correct, total: total, percentage: accuracy, streak: state.streak });
  summaryListEl.innerHTML = '';
  state.results.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'summary-item ' + (r.correct?'correct':'incorrect');
    div.innerHTML = `
      <div><strong>${getText('questionLabelShort')}:</strong> ${r.prompt}</div>
  <div><strong>${getText('yourAnswer')}:</strong> ${r.chosenDisplay}</div>
  <div><strong>${getText('correctLabel')}:</strong> ${r.correctDisplay}</div>
      <div class="ref"><strong>${getText('references')}:</strong> ${(r.ref||[]).join(', ')}</div>
    `;
    summaryListEl.appendChild(div);
  });
  modalEl.style.display = 'flex';
}

function hideSummaryModal(){
  if(modalEl) modalEl.style.display = 'none';
}

// Players modal
function showPlayersModal(){
  p1NameInput.value = 'P1';
  p2NameInput.value = 'P2';
  playersModal.style.display = 'flex';
}

function hidePlayersModal(){
  playersModal.style.display = 'none';
}

// =========================
// Toasts
// =========================
function showToast({ title, msg, type='info', timeout=3000 }){
  if(!toastContainer) return;
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `
    <div>
      <div class="title">${title||''}</div>
      <div class="msg">${msg||''}</div>
    </div>
    <div class="close" aria-label="Close">✕</div>
  `;
  const closer = el.querySelector('.close');
  closer.addEventListener('click',()=>{ el.remove(); });
  // Append without affecting layout (container is fixed and centered)
  toastContainer.appendChild(el);
  if(timeout>0){ setTimeout(()=>{ el.remove(); }, timeout); }
}

function scheduleTimeWarnings(){
  if(state.mode!=='timed') return;
  // Lightweight warnings when passing thresholds
  const warnAt = new Set([30, 10, 5]);
  const check = ()=>{
    const t = state.timerSecondsRemaining;
    if(warnAt.has(t)){
      showToast({ title: getText('timeWarning'), msg: getText('timeWarningMsg', { time: t }), type: t<=5?'error':'warn', timeout: 1200 });
      warnAt.delete(t);
    }
    if(state.timerId) requestAnimationFrame(check);
  };
  requestAnimationFrame(check);
}

// Re-localize dynamic pieces when language changes
window.onWhoBibleLanguageChange = function(lang){
  try{
    // Re-render study list (people) to reflect translated events/occupations
    if(document.getElementById('study-panel') && state.people.length>0){
      renderPeopleList(searchPerson.value || '');
    }
    // Rebuild current question prompt and answer labels if a quiz is active
    if(state.current){
      renderQuestion(state.current);
      // Update answers display text for current choices
      const nodes = Array.from(document.querySelectorAll('#answers .ans'));
      nodes.forEach(node=>{
        const orig = node.dataset.value;
        const q = state.current;
        node.innerText = (typeof translateAnswerForQuestionType==='function') ? translateAnswerForQuestionType(q.type, orig) : orig;
      });
    }
  }catch(_){ /* non-fatal */ }
};

async function loadWikidataForReview() {
    try {
        const response = await fetch('tools/people_from_wikidata.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const wikidataPeople = await response.json();
        
        // Get existing names to prevent duplicates
        const existingNames = new Set(state.people.map(p => p.name.toLowerCase()));
        
        const newPeople = wikidataPeople.filter(p => !existingNames.has(p.name.toLowerCase()));

        if (newPeople.length === 0) {
            alert('No new people to import from the Wikidata file. All names already exist in the current dataset.');
            return;
        }

        // Add a flag to distinguish these as needing review
        newPeople.forEach(p => {
            p._for_review = true;
        });

        // Add to the main people array and re-render the quality report
        state.people.push(...newPeople);
        renderDataQualityReport();
        
        alert(`Loaded ${newPeople.length} new people from Wikidata for review.`);

    } catch (error) {
        console.error('Error loading Wikidata for review:', error);
        alert('Failed to load Wikidata file. Make sure it exists in the `tools` directory and the server is running.');
    }
}

function attachEventHandlers() {
  document.getElementById('btn-data-quality').addEventListener('click', showDataQualityModal);
  document.getElementById('close-data-quality-modal').addEventListener('click', hideDataQualityModal);
  document.getElementById('btn-export-data-quality').addEventListener('click', exportDataQualityReport);
  document.getElementById('btn-accept-all-inferred').addEventListener('click', acceptAllInferred);
  document.getElementById('btn-load-wikidata').addEventListener('click', loadWikidataForReview);


  document.getElementById('btn-save-person').addEventListener('click', savePersonFromEditor);
  document.getElementById('close-person-editor-modal').addEventListener('click', hidePersonEditor);

  // Mode buttons
  btnSolo.addEventListener('click', startSolo);
  btnTimed.addEventListener('click', startTimed);
  btnChallenge.addEventListener('click', startChallenge);
  btnStudy.addEventListener('click', startStudy);
  
  // Navigation
  btnBackToSetup.addEventListener('click', showSetup);
  btnBackFromStudy.addEventListener('click', showSetup);
  // Community moved to separate page
  
  // Game controls
  btnNext.addEventListener('click', nextQuestion);
  btnQuit.addEventListener('click', quitQuiz);
  btnPause.addEventListener('click', togglePause);
  
  // Study controls
  searchPerson.addEventListener('input', e=>renderPeopleList(e.target.value));
  sortSelect.addEventListener('change', ()=>renderPeopleList(searchPerson.value));
  filterMother.addEventListener('change', ()=>renderPeopleList(searchPerson.value));
  filterOccupation.addEventListener('change', ()=>renderPeopleList(searchPerson.value));
  filterAge.addEventListener('change', ()=>renderPeopleList(searchPerson.value));
  btnShuffleList.addEventListener('click', ()=>{ shuffle(state.people); renderPeopleList(searchPerson.value); });
  btnExpandAll.addEventListener('click', ()=>toggleAllDetails(true));
  btnCollapseAll.addEventListener('click', ()=>toggleAllDetails(false));
  if(showDetailsToggle){ showDetailsToggle.addEventListener('change', ()=>renderPeopleList(searchPerson.value)); }
  if(showRelativesToggle){ showRelativesToggle.addEventListener('change', ()=>renderPeopleList(searchPerson.value)); }
  if(motherSelect){ motherSelect.addEventListener('change', ()=>renderPeopleList(searchPerson.value)); }
  if(showMothersOnly){ showMothersOnly.addEventListener('change', ()=>renderPeopleList(searchPerson.value)); }
  if(testamentSelect){ testamentSelect.addEventListener('change', ()=>{ saveSettingsFromUI(); renderPeopleList(searchPerson.value); }); }
  if(genderSelect){ genderSelect.addEventListener('change', ()=>{ saveSettingsFromUI(); renderPeopleList(searchPerson.value); }); }
  
  // Data management
  btnExport.addEventListener('click', exportJson);
  btnImport.addEventListener('click', ()=>fileInput.click());
  btnResetData.addEventListener('click', resetData);
  fileInput.addEventListener('change', handleImportFile);

  // Data Quality / Person Editor wiring
  const btnDQ = document.getElementById('btn-data-quality');
  if (btnDQ) btnDQ.addEventListener('click', showDataQualityModal);
  const dqClose = document.getElementById('btn-data-quality-close');
  if (dqClose) dqClose.addEventListener('click', hideDataQualityModal);
  const dqClose2 = document.getElementById('btn-dq-close');
  if (dqClose2) dqClose2.addEventListener('click', hideDataQualityModal);
  const dqExport = document.getElementById('btn-dq-export');
  if (dqExport) dqExport.addEventListener('click', exportDataQualityReport);
  const dqAcceptAll = document.getElementById('btn-dq-accept-all');
  if (dqAcceptAll) dqAcceptAll.addEventListener('click', ()=>{
    if(confirm('This will accept all inferred testament/gender values and remove their inferred flags. A backup of flagged records will be downloaded first. Proceed?')){
      acceptAllInferred();
    }
  });

  const peClose = document.getElementById('btn-person-editor-close');
  if (peClose) peClose.addEventListener('click', hidePersonEditor);
  const peCancel = document.getElementById('btn-person-cancel');
  if (peCancel) peCancel.addEventListener('click', (e)=>{ e.preventDefault(); hidePersonEditor(); });
  const peSave = document.getElementById('btn-person-save');
  if (peSave) peSave.addEventListener('click', (e)=>{ e.preventDefault(); savePersonFromEditor(); });
  
  // Settings persistence
  difficultySel.addEventListener('change', saveSettingsFromUI);
  numQuestionsInput.addEventListener('change', saveSettingsFromUI);
  timeLimitInput.addEventListener('change', saveSettingsFromUI);
  
  // Language selector
  languageSelect.addEventListener('change', (e) => {
    const lang = e.target.value;
    // Persist preferred language as part of settings as well
    const settings = loadSettings() || {};
    settings.language = lang;
    try{ localStorage.setItem('settings', JSON.stringify(settings)); }catch(_){/* ignore */}
    setLanguage(lang);
    // Re-render visible question if any
    if(state.current){
      // Rebuild prompt with translated pieces when possible
      const q = state.current;
      // We cannot perfectly rebuild dynamic tokens here without source data; keep prompt as-is,
      // but refresh choices labels and status/headers via updateAllText called by setLanguage.
      // Future: store raw tokens to fully re-localize prompt.
      // Refresh answers display text
      const nodes = Array.from(document.querySelectorAll('#answers .ans'));
      nodes.forEach(node=>{
        const orig = node.dataset.value;
        const q = state.current;
        node.innerText = (typeof translateAnswerForQuestionType==='function') ? translateAnswerForQuestionType(q.type, orig) : orig;
      });
    }
  });
  
  // Theme toggle: cycle between day and night
  if (btnTheme) {
    btnTheme.addEventListener('click', ()=>{
      console.log('Theme button clicked!'); // Debug
      console.log('Current state.theme:', state.theme); // Debug
      console.log('Body classes:', document.body.className); // Debug
      
      // Use state.theme as the source of truth
      const current = state.theme || 'night';
      const next = current === 'night' ? 'day' : 'night';
      
      console.log('Switching from', current, 'to', next); // Debug
      applyTheme(next);
      saveSettingsFromUI();
    });
  } else {
    console.log('btnTheme not found!'); // Debug
  }
  // Share
  if (btnShare) {
    btnShare.addEventListener('click', async ()=>{
      const shareData = {
        title: 'Who-Bible',
        text: getText('brandDesc'),
        url: location.href
      };
      if (navigator.share) {
        try { await navigator.share(shareData); } catch(_){}
      } else {
        try {
          await navigator.clipboard.writeText(`${shareData.title} — ${shareData.url}`);
          showToast({ title: getText('exportSuccess'), msg: getText('exportMsg'), type: 'success', timeout: 1500 });
        } catch(_) {
          showToast({ title: getText('importError'), msg: 'Clipboard unavailable', type: 'error', timeout: 1500 });
        }
      }
    });
  }
  // Community placeholder behavior
  // Community opens in a new tab via anchor href
  
  // Modal handlers
  btnSummaryClose.addEventListener('click', hideSummaryModal);
  btnPlayAgain.addEventListener('click', ()=>{ hideSummaryModal(); showSetup(); });
  btnPlayersClose.addEventListener('click', hidePlayersModal);
  btnPlayersCancel.addEventListener('click', hidePlayersModal);
  btnPlayersStart.addEventListener('click', startChallengeFromModal);
  
  // Keyboard navigation on answers
  answersEl.addEventListener('keydown', onAnswersKeyDown);

}

